<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Data Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the file input appearance */
        input[type="file"]::-webkit-file-upload-button {
            cursor: pointer;
        }
        input[type="file"]::file-selector-button {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="container max-w-lg w-full bg-white shadow-xl rounded-2xl p-8 space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center border-b pb-3">
            XLSX Order Data Importer
        </h1>

        <div id="statusMessage" class="hidden p-3 rounded-xl text-sm font-medium transition-all duration-300" role="alert"></div>

        <form id="uploadForm" class="space-y-4">
            <label class="block text-gray-700 font-semibold">
                Upload Order File (.xlsx)
            </label>
            <input 
                type="file" 
                id="orderFile" 
                name="orderFile" 
                accept=".xlsx" 
                class="block w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-indigo-50 file:text-indigo-600
                       hover:file:bg-indigo-100"
                required
            >
            <p class="text-xs text-gray-500 mt-1">
                The file must contain the specified columns (Bill Number, Item Name, etc.).
            </p>

            <button 
                type="submit" 
                id="submitBtn"
                class="w-full bg-indigo-600 text-white py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-150 font-bold shadow-md disabled:bg-indigo-300"
            >
                Start Import
            </button>
        </form>

        <div id="results" class="space-y-2 mt-6 p-4 border rounded-xl bg-gray-50 hidden">
            <h2 class="text-xl font-semibold text-gray-800">Import Summary</h2>
            <p class="text-gray-600">Total Orders Processed: <span id="totalProcessed" class="font-bold text-indigo-600"></span></p>
            <p class="text-gray-600">Successfully Imported: <span id="successfulInserts" class="font-bold text-green-600"></span></p>
            <p class="text-gray-600">Skipped (Duplicates): <span id="skippedDuplicates" class="font-bold text-yellow-600"></span></p>
            <p class="text-gray-600">Failed (Errors): <span id="failedInserts" class="font-bold text-red-600"></span></p>
        </div>
        
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('orderFile');
            const submitBtn = document.getElementById('submitBtn');

            // --- UI Pre-Submission Reset ---
            const file = fileInput.files[0];
            if (!file) {
                showAlert('Please select a file.', 'bg-red-100 text-red-800');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing... Please Wait.';
            document.getElementById('results').classList.add('hidden');

            const formData = new FormData();
            // 'orderFile' must match the multer upload field name in app.js
            formData.append('orderFile', file); 

            showAlert('Upload started. Processing data on the server...', 'bg-blue-100 text-blue-800');

            try {
                // The fetch URL maps to your Express route
                const response = await fetch('http://localhost:3000/api/import-orders', { 
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // Success response (HTTP 200)
                    showAlert(data.message, 'bg-green-100 text-green-800');
                    displayResults(data.summary);
                } else {
                    // Server error response (HTTP 4xx or 5xx)
                    showAlert(`Import Error: ${data.message || data.detail || 'Unknown server error.'}`, 'bg-red-100 text-red-800');
                }
            } catch (error) {
                // Network or fetch error
                console.error('Network or fetch error:', error);
                showAlert('A critical network error occurred. Check server connection.', 'bg-red-100 text-red-800');
            } finally {
                // --- UI Post-Submission Cleanup ---
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Import';
            }
        });

        // Utility function to display alerts
        function showAlert(message, className) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `p-3 rounded-xl text-sm font-medium transition-all duration-300 ${className}`;
            statusDiv.classList.remove('hidden');
        }

        // Utility function to display import summary
        function displayResults(summary) {
    document.getElementById('totalProcessed').textContent = summary.totalProcessed;
    document.getElementById('successfulInserts').textContent = summary.successfulInserts;
    document.getElementById('skippedDuplicates').textContent = summary.skippedDuplicates;
    document.getElementById('failedInserts').textContent = summary.failedInserts;
    document.getElementById('results').classList.remove('hidden');
}
    </script>
</body>
</html>